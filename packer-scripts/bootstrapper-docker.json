{
  "variables": {
    "terraform_version": "0.12.12",
    "nomad_version": "0.10.0",
    "consul_version": "1.6.1",
    "ucloud_cli_version": "0.1.27",
    "tf_plugin_consul_version": "2.5.0",
    "tf_plugin_nomad_version": "1.4.2",
    "tf_plugin_null_version": "2.1.2",
    "tf_plugin_template_version": "2.1.2",
    "tf_plugin_ucloud_version": "1.14.0",
    "tf_plugin_external_version": "1.2.0",
    "tf_plugin_local_version": "1.4.0",
    "yum_base": "http://mirrors.163.com/.help/CentOS7-Base-163.repo",
    "yum_docker": "https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo",
    "docker_repo": "",
    "image_tag": "",
    "docker_login_server": "",
    "docker_login_username": "",
    "docker_login_password": "",
    "code_git_url": "",
    "golang_version": "1.13.3",
    "file_server": "http://hashicorpfile.cn-bj.ufileos.com"
  },

  "builders": [{
    "type": "docker",
    "image": "centos:7",
    "commit": true,
    "changes": [
      "ENTRYPOINT [\"/bin/bash\", \"-c\"]",
      "CMD [\"sleep infinity\"]",
      "ENV GOROOT /usr/local/go",
      "ENV GOPATH /go",
      "ENV PATH $GOPATH/bin:$GOROOT/bin:$PATH"
    ]
  }],
  "provisioners": [
    {
      "type": "shell",
      "scripts": [
        "../scripts/config-yum.sh",
        "../scripts/install-bootstrapper.sh",
        "../scripts/build-terraform-plugin-cache.sh",
        "../scripts/install-golang.sh"
      ],
      "environment_vars": [
        "TERRAFORM_VERSION={{user `terraform_version`}}",
        "NOMAD_VERSION={{user `nomad_version`}}",
        "CONSUL_VERSION={{user `consul_version`}}",
        "TF_PLUGIN_CONSUL_VERSION={{user `tf_plugin_consul_version`}}",
        "TF_PLUGIN_NOMAD_VERSION={{user `tf_plugin_nomad_version`}}",
        "TF_PLUGIN_NULL_VERSION={{user `tf_plugin_null_version`}}",
        "TF_PLUGIN_TEMPLATE_VERSION={{user `tf_plugin_template_version`}}",
        "TF_PLUGIN_UCLOUD_VERSION={{user `tf_plugin_ucloud_version`}}",
        "TF_PLUGIN_EXTERNAL_VERSION={{user `tf_plugin_external_version`}}",
        "TF_PLUGIN_LOCAL_VERSION={{user `tf_plugin_local_version`}}",
        "YUM_BASE={{user `yum_base`}}",
        "YUM_DOCKER={{user `yum_docker`}}",
        "UCLOUD_CLI_VERSION={{user `ucloud_cli_version`}}",
        "CODE_GIT_URL={{user `code_git_url`}}",
        "GOLANG_VERSION={{user `golang_version`}}",
        "FILE_SERVER={{user `file_server`}}"
      ]
    }],
  "post-processors": [
    [
      {
        "type": "docker-tag",
        "repository": "{{user `docker_repo`}}",
        "tag": "{{user `image_tag`}}"
      },
      {
        "type": "docker-push",
        "login_server": "{{user `docker_login_server`}}",
        "login_username": "{{user `docker_login_username`}}",
        "login_password": "{{user `docker_login_password`}}",
        "login": true
      }
    ]
  ]
}
